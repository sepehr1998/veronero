generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AccountType {
  INDIVIDUAL @map("individual")
  BUSINESS   @map("business")
}

enum UserAccountRole {
  OWNER  @map("owner")
  ADMIN  @map("admin")
  MEMBER @map("member")
  VIEWER @map("viewer")
}

enum TaxCardStatus {
  UPLOADED   @map("uploaded")
  PROCESSING @map("processing")
  PARSED     @map("parsed")
  ERROR      @map("error")
}

enum ExpenseSource {
  MANUAL   @map("manual")
  RECEIPT  @map("receipt")
}

enum ReceiptStatus {
  UPLOADED   @map("uploaded")
  PROCESSING @map("processing")
  PARSED     @map("parsed")
  ERROR      @map("error")
}

enum TaxScenarioStatus {
  DRAFT   @map("draft")
  FINAL   @map("final")
}

enum LifeEventStatus {
  ACTIVE   @map("active")
  INACTIVE @map("inactive")
}

enum CalendarEventStatus {
  UPCOMING  @map("upcoming")
  COMPLETED @map("completed")
  DISMISSED @map("dismissed")
}

enum ChatMessageSender {
  USER       @map("user")
  ASSISTANT  @map("assistant")
  SYSTEM     @map("system")
}

enum AiCallPurpose {
  TAX_CARD_ANALYSIS   @map("tax_card_analysis")
  RECEIPT_EXTRACTION  @map("receipt_extraction")
  CHAT                @map("chat")
  OTHER               @map("other")
}

model User {
  id          String          @id @default(uuid()) @db.Uuid
  auth0Id     String          @unique @map("auth0_user_id")
  email       String          @unique
  fullName    String?         @map("full_name")
  locale      String?
  lastLoginAt DateTime?       @map("last_login_at")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  accounts    UserAccount[]
  taxProfiles UserTaxProfile[]
  taxCards    TaxCard[]
  expenses    Expense[]
  receiptFiles ReceiptFile[]
  taxScenarios TaxScenario[]
  lifeEvents  UserLifeEvent[]
  calendarEvents CalendarEvent[]
  chatSessions ChatSession[]
  aiCallLogs  AiCallLog[]
  auditLogs   AuditLog[]

  @@map("users")
}

model Account {
  id          String          @id @default(uuid()) @db.Uuid
  name        String
  type        AccountType
  countryCode String          @map("country_code")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  users       UserAccount[]
  taxProfiles UserTaxProfile[]
  taxCards    TaxCard[]
  expenses    Expense[]
  receiptFiles ReceiptFile[]
  taxScenarios TaxScenario[]
  lifeEvents  UserLifeEvent[]
  calendarEvents CalendarEvent[]
  country     Country         @relation(fields: [countryCode], references: [code])
  chatSessions ChatSession[]

  @@map("accounts")
}

model UserAccount {
  id        String           @id @default(uuid()) @db.Uuid
  userId    String           @map("user_id") @db.Uuid
  accountId String           @map("account_id") @db.Uuid
  role      UserAccountRole
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")

  user      User             @relation(fields: [userId], references: [id])
  account   Account          @relation(fields: [accountId], references: [id])

  @@unique([userId, accountId])
  @@map("user_accounts")
}

model Country {
  code       String       @id
  name       String
  accounts   Account[]
  taxRegimes TaxRegime[]

  @@map("countries")
}

model TaxRegime {
  id          String              @id @default(uuid()) @db.Uuid
  countryCode String              @map("country_code")
  slug        String              @unique
  displayName String              @map("display_name")
  isActive    Boolean             @default(true) @map("is_active")
  createdAt   DateTime            @default(now()) @map("created_at")
  updatedAt   DateTime            @updatedAt @map("updated_at")

  country     Country             @relation(fields: [countryCode], references: [code])
  settings    TaxRegimeSetting[]
  userProfiles UserTaxProfile[]
  taxCards    TaxCard[]
  expenseCategories ExpenseCategory[]
  expenses    Expense[]
  taxScenarios TaxScenario[]
  lifeEventTypes LifeEventType[]
  calendarEventTemplates CalendarEventTemplate[]
  chatSessions ChatSession[]

  @@map("tax_regimes")
}

model TaxRegimeSetting {
  id            String     @id @default(uuid()) @db.Uuid
  taxRegimeId   String     @map("tax_regime_id") @db.Uuid
  settingsJson  Json       @map("settings_json")
  validFrom     DateTime?  @map("valid_from")
  validTo       DateTime?  @map("valid_to")
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  taxRegime     TaxRegime  @relation(fields: [taxRegimeId], references: [id])

  @@map("tax_regime_settings")
}

model UserTaxProfile {
  id              String     @id @default(uuid()) @db.Uuid
  userId          String     @map("user_id") @db.Uuid
  accountId       String     @map("account_id") @db.Uuid
  taxRegimeId     String     @map("tax_regime_id") @db.Uuid
  occupation      String?
  profileDataJson Json       @map("profile_data_json")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  user            User       @relation(fields: [userId], references: [id])
  account         Account    @relation(fields: [accountId], references: [id])
  taxRegime       TaxRegime  @relation(fields: [taxRegimeId], references: [id])
  scenarios       TaxScenario[] @relation("ScenarioProfile")

  @@map("user_tax_profiles")
}

model TaxCard {
  id             String           @id @default(uuid()) @db.Uuid
  userId         String           @map("user_id") @db.Uuid
  accountId      String           @map("account_id") @db.Uuid
  taxRegimeId    String           @map("tax_regime_id") @db.Uuid
  fileStorageKey String           @map("file_storage_key")
  status         TaxCardStatus    @default(UPLOADED)
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")

  user           User             @relation(fields: [userId], references: [id])
  account        Account          @relation(fields: [accountId], references: [id])
  taxRegime      TaxRegime        @relation(fields: [taxRegimeId], references: [id])
  parsed         TaxCardParsed?
  analyses       TaxCardAnalysis[]
  scenarios      TaxScenario[]    @relation("ScenarioTaxCard")

  @@map("tax_cards")
}

model TaxCardParsed {
  id                           String    @id @default(uuid()) @db.Uuid
  taxCardId                    String    @unique @map("tax_card_id") @db.Uuid
  sourceJson                   Json      @map("source_json")
  withholdingPercentage        Decimal   @map("withholding_percentage")
  secondaryWithholdingPercentage Decimal? @map("secondary_withholding_percentage")
  incomeLimit                  Decimal   @map("income_limit")
  validFrom                    DateTime  @map("valid_from")
  validTo                      DateTime? @map("valid_to")
  otherFieldsJson              Json      @map("other_fields_json")

  taxCard                      TaxCard   @relation(fields: [taxCardId], references: [id])

  @@map("tax_card_parsed")
}

model TaxCardAnalysis {
  id                   String   @id @default(uuid()) @db.Uuid
  taxCardId            String   @map("tax_card_id") @db.Uuid
  aiSummaryText        String   @map("ai_summary_text")
  keyPointsJson        Json     @map("key_points_json")
  recommendationsJson  Json     @map("recommendations_json")
  createdAt            DateTime @default(now()) @map("created_at")

  taxCard              TaxCard  @relation(fields: [taxCardId], references: [id])

  @@index([taxCardId])
  @@map("tax_card_analyses")
}

model ExpenseCategory {
  id           String     @id @default(uuid()) @db.Uuid
  taxRegimeId  String     @map("tax_regime_id") @db.Uuid
  code         String
  displayName  String     @map("display_name")
  description  String?
  isActive     Boolean    @default(true) @map("is_active")

  taxRegime    TaxRegime  @relation(fields: [taxRegimeId], references: [id])
  expenses     Expense[]
  receiptSuggestions ReceiptExtraction[]

  @@map("expense_categories")
  @@unique([taxRegimeId, code])
}

model Expense {
  id           String         @id @default(uuid()) @db.Uuid
  userId       String         @map("user_id") @db.Uuid
  accountId    String         @map("account_id") @db.Uuid
  taxRegimeId  String         @map("tax_regime_id") @db.Uuid
  occurredAt   DateTime       @map("occurred_at")
  amount       Decimal        @db.Decimal
  currency     String
  categoryId   String         @map("category_id") @db.Uuid
  description  String?
  isDeductible Boolean        @map("is_deductible")
  source       ExpenseSource
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  user         User           @relation(fields: [userId], references: [id])
  account      Account        @relation(fields: [accountId], references: [id])
  taxRegime    TaxRegime      @relation(fields: [taxRegimeId], references: [id])
  category     ExpenseCategory @relation(fields: [categoryId], references: [id])

  @@map("expenses")
  @@index([accountId, occurredAt])
}

model ReceiptFile {
  id             String        @id @default(uuid()) @db.Uuid
  userId         String        @map("user_id") @db.Uuid
  accountId      String        @map("account_id") @db.Uuid
  fileStorageKey String        @map("file_storage_key")
  status         ReceiptStatus @default(UPLOADED)
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  user           User          @relation(fields: [userId], references: [id])
  account        Account       @relation(fields: [accountId], references: [id])
  extractions    ReceiptExtraction[]

  @@map("receipt_files")
}

model ReceiptExtraction {
  id                   String           @id @default(uuid()) @db.Uuid
  receiptFileId        String           @unique @map("receipt_file_id") @db.Uuid
  extractedJson        Json             @map("extracted_json")
  suggestedAmount      Decimal          @map("suggested_amount")
  suggestedDate        DateTime         @map("suggested_date")
  suggestedCategoryId  String?          @map("suggested_category_id") @db.Uuid
  confidenceScore      Decimal          @map("confidence_score")
  createdAt            DateTime         @default(now()) @map("created_at")

  receiptFile          ReceiptFile      @relation(fields: [receiptFileId], references: [id])
  suggestedCategory    ExpenseCategory? @relation(fields: [suggestedCategoryId], references: [id])

  @@map("receipt_extractions")
}

model TaxScenario {
  id                 String       @id @default(uuid()) @db.Uuid
  userId             String       @map("user_id") @db.Uuid
  accountId          String       @map("account_id") @db.Uuid
  taxRegimeId        String       @map("tax_regime_id") @db.Uuid
  name               String
  description        String?
  basedOnTaxCardId   String?      @map("based_on_tax_card_id") @db.Uuid
  basedOnProfileId   String?      @map("based_on_profile_id") @db.Uuid
  createdAt          DateTime     @default(now()) @map("created_at")
  updatedAt          DateTime     @updatedAt @map("updated_at")

  user               User         @relation(fields: [userId], references: [id])
  account            Account      @relation(fields: [accountId], references: [id])
  taxRegime          TaxRegime    @relation(fields: [taxRegimeId], references: [id])
  basedOnTaxCard     TaxCard?     @relation("ScenarioTaxCard", fields: [basedOnTaxCardId], references: [id])
  basedOnProfile     UserTaxProfile? @relation("ScenarioProfile", fields: [basedOnProfileId], references: [id])
  inputs             TaxScenarioInput[]
  results            TaxScenarioResult[]
  recommendations    TaxScenarioRecommendation[]

  @@map("tax_scenarios")
}

model TaxScenarioInput {
  id              String     @id @default(uuid()) @db.Uuid
  scenarioId      String     @map("scenario_id") @db.Uuid
  incomeJson      Json       @map("income_json")
  deductionsJson  Json       @map("deductions_json")
  assumptionsJson Json       @map("assumptions_json")
  lifeEventsJson  Json       @map("life_events_json")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  scenario        TaxScenario @relation(fields: [scenarioId], references: [id])

  @@map("tax_scenario_inputs")
}

model TaxScenarioResult {
  id              String     @id @default(uuid()) @db.Uuid
  scenarioId      String     @map("scenario_id") @db.Uuid
  taxableIncome   Decimal    @map("taxable_income")
  estimatedTax    Decimal    @map("estimated_tax")
  netIncome       Decimal    @map("net_income")
  breakdownJson   Json       @map("breakdown_json")
  comparisonsJson Json?      @map("comparisons_json")
  createdAt       DateTime   @default(now()) @map("created_at")

  scenario        TaxScenario @relation(fields: [scenarioId], references: [id])

  @@map("tax_scenario_results")
}

model TaxScenarioRecommendation {
  id                   String     @id @default(uuid()) @db.Uuid
  scenarioId           String     @map("scenario_id") @db.Uuid
  aiSummaryText        String     @map("ai_summary_text")
  recommendationsJson  Json       @map("recommendations_json")
  createdAt            DateTime   @default(now()) @map("created_at")

  scenario             TaxScenario @relation(fields: [scenarioId], references: [id])

  @@map("tax_scenario_recommendations")
}

model LifeEventType {
  id                 String     @id @default(uuid()) @db.Uuid
  taxRegimeId        String     @map("tax_regime_id") @db.Uuid
  code               String
  displayName        String     @map("display_name")
  description        String?
  questionsSchemaJson Json      @map("questions_schema_json")
  isActive           Boolean    @default(true) @map("is_active")

  taxRegime          TaxRegime  @relation(fields: [taxRegimeId], references: [id])
  userLifeEvents     UserLifeEvent[]

  @@map("life_event_types")
  @@unique([taxRegimeId, code])
}

model UserLifeEvent {
  id               String        @id @default(uuid()) @db.Uuid
  userId           String        @map("user_id") @db.Uuid
  accountId        String        @map("account_id") @db.Uuid
  lifeEventTypeId  String        @map("life_event_type_id") @db.Uuid
  answersJson      Json          @map("answers_json")
  occurredAt       DateTime      @map("occurred_at")
  createdAt        DateTime      @default(now()) @map("created_at")

  user             User          @relation(fields: [userId], references: [id])
  account          Account       @relation(fields: [accountId], references: [id])
  lifeEventType    LifeEventType @relation(fields: [lifeEventTypeId], references: [id])

  @@map("user_life_events")
  @@index([accountId, occurredAt])
}

model CalendarEventTemplate {
  id           String       @id @default(uuid()) @db.Uuid
  taxRegimeId  String       @map("tax_regime_id") @db.Uuid
  code         String
  description  String?
  ruleJson     Json         @map("rule_json")
  isActive     Boolean      @default(true) @map("is_active")

  taxRegime    TaxRegime    @relation(fields: [taxRegimeId], references: [id])
  events       CalendarEvent[]

  @@map("calendar_event_templates")
  @@unique([taxRegimeId, code])
}

model CalendarEvent {
  id          String                @id @default(uuid()) @db.Uuid
  userId      String                @map("user_id") @db.Uuid
  accountId   String                @map("account_id") @db.Uuid
  templateId  String?               @map("template_id") @db.Uuid
  title       String
  description String?
  startAt     DateTime              @map("start_at")
  endAt       DateTime              @map("end_at")
  status      CalendarEventStatus
  createdAt   DateTime              @default(now()) @map("created_at")
  updatedAt   DateTime              @updatedAt @map("updated_at")

  user        User                  @relation(fields: [userId], references: [id])
  account     Account               @relation(fields: [accountId], references: [id])
  template    CalendarEventTemplate? @relation(fields: [templateId], references: [id])

  @@map("calendar_events")
  @@index([accountId, startAt])
}

model ChatSession {
  id           String       @id @default(uuid()) @db.Uuid
  userId       String       @map("user_id") @db.Uuid
  accountId    String       @map("account_id") @db.Uuid
  taxRegimeId  String       @map("tax_regime_id") @db.Uuid
  title        String
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  user         User         @relation(fields: [userId], references: [id])
  account      Account      @relation(fields: [accountId], references: [id])
  taxRegime    TaxRegime    @relation(fields: [taxRegimeId], references: [id])
  messages     ChatMessage[]

  @@map("chat_sessions")
  @@index([accountId, createdAt])
}

model ChatMessage {
  id           String            @id @default(uuid()) @db.Uuid
  sessionId    String            @map("session_id") @db.Uuid
  sender       ChatMessageSender
  messageText  String            @map("message_text")
  metadataJson Json?             @map("metadata_json")
  createdAt    DateTime          @default(now()) @map("created_at")

  session      ChatSession       @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
  @@index([sessionId, createdAt])
}

model AiCallLog {
  id              String        @id @default(uuid()) @db.Uuid
  userId          String?       @map("user_id") @db.Uuid
  purpose         AiCallPurpose
  modelName       String        @map("model_name")
  tokenUsageJson  Json          @map("token_usage_json")
  costEstimate    Decimal?      @map("cost_estimate") @db.Decimal
  createdAt       DateTime      @default(now()) @map("created_at")

  user            User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("ai_call_logs")
  @@index([userId, createdAt])
}

model AuditLog {
  id            String     @id @default(uuid()) @db.Uuid
  userId        String?    @map("user_id") @db.Uuid
  action        String
  resourceType  String     @map("resource_type")
  resourceId    String     @map("resource_id")
  detailsJson   Json       @map("details_json")
  createdAt     DateTime   @default(now()) @map("created_at")

  user          User?      @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
  @@index([userId, createdAt])
}
